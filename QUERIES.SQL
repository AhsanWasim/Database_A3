/*QUESTION 1 
All the players that have played under a specific manager.*/
SELECT PLAYER_ID, FIRST_NAME , LAST_NAME, NATIONALITY,DOB ,
TEAM_ID, TEAM_NAME, COUNTRY 
FROM players PL JOIN TEAMS TM ON PL.TEAM_ID = TM.ID
WHERE TEAM_ID = (SELECT TEAM_ID FROM MANAGERS WHERE FIRST_NAME = 'STEFANO') 
ORDER BY PLAYER_ID ASC;


/*

2. All the matches that have been played in a specific country.
*/

SELECT MATCH_ID, SEASON, DATE_TIME, HOME_TEAM_ID, AWAY_TEAM_ID, STADIUM_ID, COUNTRY FROM MATCHES
JOIN STADIUMS ON STADIUM_ID = STADIUMS.ID
WHERE COUNTRY = 'Italy'

--IN THE WHERE CLAUSE CHANGE THE COUNTRY OF YOUR CHOICE!



/*QUESTION 3
All the teams that have won more than 3 matches in their home stadium.
(Assume a team wins only if they scored more goals then other team)*/
SELECT t.ID,T.team_name, T.COUNTRY,T.HOME_STADIUM_ID
FROM teams T
INNER JOIN matches ON t.id = matches.HOME_TEAM_ID
INNER JOIN match_report ON matches.match_id = match_report.match_id
WHERE match_report.HOME_TEAM_SCORE > match_report.AWAY_TEAM_SCORE
GROUP BY t.ID,T.TEAM_NAME, T.COUNTRY,T.HOME_STADIUM_ID
HAVING COUNT(*) > 3;



/*
4. All the teams with foreign managers.
*/

SELECT TEAMS.ID AS 'TEAM_ID', TEAM_NAME, COUNTRY, HOME_STADIUM_ID, FIRST_NAME AS 'MANAGER''S FNAME', LAST_NAME AS 'MANAGER''S LNAME', DOB, NATIONALITY
FROM TEAMS
JOIN MANAGERS ON TEAMS.ID = MANAGERS.TEAM_ID
WHERE COUNTRY != NATIONALITY



/*QUESTION 5
All the matches that were played in stadiums with seating capacity greater
than 60,000.
*/
SELECT MATCH_ID, SEASON, DATE_TIME, M.STADIUM_ID, S.NAME, S.CITY, S.COUNTRY, S.CAPACITY
FROM matches M JOIN STADIUM S ON M.STADIUM_ID = S.ID
WHERE S.CAPACITY > 60000;


/*

6. All Goals made without an assist in 2020 by players having height greater
than 180 cm. */

SELECT SEASON, DATE_TIME, HOME_TEAM_ID, AWAY_TEAM_ID, STADIUM_ID GOAL_ID, GOALS.MATCH_ID, PID AS 'PLAYER ID',
DURATION, ASSIST, GOAL_DESC, JERSEY_NUMBER, POSITION, HEIGHT, WEIGHT, FOOT

FROM GOALS 
JOIN PLAYERS_DESCRIPTION ON PID = PLAYER_ID
JOIN MATCHES ON GOALS.MATCH_ID = MATCHES.MATCH_ID
WHERE ASSIST IS NULL AND HEIGHT > 180 AND SEASON LIKE '2020%'



/*QUESTION 7
All Russian teams with win percentage less than 50% in home matches.
*/
SELECT teams.team_name, COUNT(*) AS total_matches, 
SUM(CASE WHEN match_report.HOME_TEAM_SCORE > match_report.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) AS home_wins,
SUM(CASE WHEN match_report.HOME_TEAM_SCORE < match_report.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) AS home_losses,
SUM(CASE WHEN match_report.HOME_TEAM_SCORE = match_report.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) AS home_draws,
ROUND(SUM(CASE WHEN match_report.HOME_TEAM_SCORE > match_report.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) 
AS home_win_percentage
FROM teams
INNER JOIN matches ON teams.id = matches.HOME_TEAM_ID
INNER JOIN match_report ON matches.match_id = match_report.match_id
WHERE teams.country = 'Russia'
GROUP BY teams.TEAM_NAME
ORDER BY home_win_percentage;




/*

8. All Stadiums that have hosted more than 6 matches with host team having
a win percentage less than 50%.  */

SELECT S.ID,S.NAME,S.CITY,S.COUNTRY,S.CAPACITY, M.STADIUM_ID, COUNT(M.STADIUM_ID) AS [MATCH COUNT],
ROUND(SUM(CASE WHEN MR.HOME_TEAM_SCORE > 
MR.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS [WINS_PERCENTAGE]
FROM STADIUMs S JOIN matches M
ON S.ID = M.STADIUM_ID
JOIN TEAMS T ON T.ID = M.HOME_TEAM_ID
JOIN match_report MR ON MR.MATCH_ID = M.MATCH_ID
GROUP BY S.ID,S.NAME,S.CITY,S.COUNTRY,S.CAPACITY, M.STADIUM_ID 
HAVING COUNT(M.STADIUM_ID) > 6 AND
ROUND(SUM(CASE WHEN MR.HOME_TEAM_SCORE > 
MR.AWAY_TEAM_SCORE THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) < 50.00;



/*QUESTION 9
The season with the greatest number of left-foot goals.
*/
SELECT top 1 SEASON, COUNT(SEASON) as [GOAL COUNTS]
FROM GOALS G JOIN matches M ON G.MATCH_ID = M.MATCH_ID
WHERE GOAL_DESC = 'LEFT-FOOTED SHOT' 
GROUP BY SEASON
ORDER BY COUNT(SEASON) desc;



/*

10. The country with maximum number of players with at least one goal.
*/

SELECT TOP 1 P.NATIONALITY AS 'COUNTRY WITH MOST GOALS', COUNT(DISTINCT G.PID) AS GOAL_AMOUNT
FROM PLAYERS P
JOIN GOALS G ON P.PLAYER_ID = G.PID
WHERE G.PID IS NOT NULL
GROUP BY P.NATIONALITY
ORDER BY GOAL_AMOUNT DESC




/*QUESTION 11
All the stadiums with greater number of left-footed shots than right-footed
shots.
*/
SELECT S.ID, S.CITY,S.COUNTRY,S.CAPACITY ,
COUNT(CASE WHEN G.GOAL_DESC = 'LEFT-FOOTED SHOT' THEN 1 END) AS [LEFT FOOT SHOTS],
COUNT(CASE WHEN G.GOAL_DESC = 'RIGHT-FOOTED SHOT' THEN 1 END) AS [RIGHT FOOT SHOTS]
FROM GOALS G JOIN matches M ON G.MATCH_ID = M.MATCH_ID
JOIN STADIUM S ON S.ID = M.STADIUM_ID
GROUP BY S.ID,S.CITY,S.COUNTRY,S.CAPACITY
HAVING COUNT(CASE WHEN G.GOAL_DESC = 'LEFT-FOOTED SHOT' THEN 1 END)
> COUNT(CASE WHEN G.GOAL_DESC = 'RIGHT-FOOTED SHOT' THEN 1 END)
ORDER BY S.ID ASC;


/*

12.All matches that were played in country with maximum cumulative stadium
seating capacity order by recent first.
*/

SELECT MATCH_ID, DATE_TIME, HOME_TEAM_ID, AWAY_TEAM_ID, STADIUM_ID, T.COUNTRY AS 'MAXIMUM CAPACITY COUNTRY', T.TOTAL_CAP_IN_COUNTRY 
FROM MATCHES
JOIN STADIUMS S ON STADIUM_ID = S.ID

JOIN (
SELECT TOP 1 STADIUMS.COUNTRY, SUM(STADIUMS.CAPACITY) AS TOTAL_CAP_IN_COUNTRY
FROM STADIUMS
GROUP BY STADIUMS.COUNTRY
ORDER BY TOTAL_CAP_IN_COUNTRY DESC
) T ON S.COUNTRY = T.COUNTRY




/*QUESTION 13
The player duo with the greatest number of goal-assist combination (i.e.
pair of players that have assisted each other in more goals than any other duo).
*/
SELECT TOP 1
p1.PLAYER_ID,
CONCAT(p1.first_name, ' ', p1.last_name) AS [PLAYER 1],
p1.DOB,p1.NATIONALITY,p1.TEAM_ID,
COUNT(*) AS [GOALS_ASSISTS],
p2.PLAYER_ID,
CONCAT(p2.first_name, ' ', p2.last_name) AS [PLAYER 2],
p2.DOB,p2.NATIONALITY,p2.TEAM_ID
FROM 
goals G1
JOIN goals G2 ON g1.assist = g2.pid AND g1.pid = g2.assist
JOIN players P1 ON g1.pid = p1.PLAYER_ID
JOIN players P2 ON g2.pid = p2.PLAYER_ID
GROUP BY  
p1.PLAYER_ID,
CONCAT(p1.first_name, ' ', p1.last_name),
p1.DOB,p1.NATIONALITY,p1.TEAM_ID,
p2.PLAYER_ID,
CONCAT(p2.first_name, ' ', p2.last_name),
p2.DOB,p2.NATIONALITY,p2.TEAM_ID
ORDER BY GOALS_ASSISTS DESC;


/*
14. The team having players with more header goal percentage than any other
team in 2020. */

SELECT TOP 1 TEAM_ID, TEAM_NAME, COUNTRY, SEASON, COUNT(TEAM_ID) AS PLAYERS,
ROUND(SUM(CASE WHEN GOALS.GOAL_DESC = 'header' THEN 1 ELSE 0 END) * 100.0 / COUNT(GOAL_ID), 2) AS [HEADER_PERCENTAGE]
FROM PLAYERS
JOIN GOALS ON PLAYERS.PLAYER_ID = GOALS.PID
JOIN MATCHES ON GOALS.MATCH_ID = MATCHES.MATCH_ID
JOIN TEAMS ON TEAM_ID = ID
WHERE TEAM_ID IS NOT NULL AND MATCHES.SEASON LIKE '2020%'
GROUP BY TEAM_ID, SEASON, TEAM_NAME, COUNTRY
ORDER BY HEADER_PERCENTAGE DESC


/*QUESTION 15
The most successful manager of UCL (2016-2022).
*/
SELECT top 1 MR.ID, CONCAT(MR.FIRST_NAME,' ',MR.LAST_NAME) AS [FULL NAME],
COUNT(CASE WHEN  HOME_TEAM_SCORE > AWAY_TEAM_SCORE THEN 1 END) +
COUNT(CASE WHEN  HOME_TEAM_SCORE < AWAY_TEAM_SCORE THEN 1 END) AS [TOTAL WINS],
MR.DOB, MR.NATIONALITY,MR.TEAM_ID
FROM TEAMS T JOIN matches M ON M.HOME_TEAM_ID = T.ID
JOIN MANAGERS MR ON MR.TEAM_ID = T.ID 
JOIN match_report MT ON MT.MATCH_ID = M.MATCH_ID
WHERE M.SEASON BETWEEN '2016-2017' AND '2021-2022'
GROUP BY MR.ID, CONCAT(MR.FIRST_NAME,' ',MR.LAST_NAME),
MR.DOB, MR.NATIONALITY,MR.TEAM_ID
ORDER BY [TOTAL WINS] DESC; 





/*

16. The winner teams for each season of UCL (2016-2022).
*/
SELECT WINS_BY_SEASON.SEASON, WINS_BY_SEASON.TEAM_NAME, WINS_BY_SEASON.MANAGER_NAME, WINS_BY_SEASON.TOTAL_WINS, T.ID AS TEAM_ID
FROM ( SELECT M.SEASON, T.TEAM_NAME, CONCAT(MR.FIRST_NAME,' ',MR.LAST_NAME) AS [MANAGER_NAME], COUNT(CASE WHEN HOME_TEAM_SCORE > AWAY_TEAM_SCORE THEN 1 END) 
AS [TOTAL_WINS], T.ID AS TEAM_ID, ROW_NUMBER() OVER (PARTITION BY M.SEASON ORDER BY COUNT(CASE WHEN HOME_TEAM_SCORE > AWAY_TEAM_SCORE THEN 1 ELSE 0 END) DESC) 
AS RN FROM TEAMS T 
JOIN MATCHES M ON M.HOME_TEAM_ID = T.ID
JOIN MANAGERS MR ON MR.TEAM_ID = T.ID 
JOIN MATCH_REPORT MT ON MT.MATCH_ID = M.MATCH_ID
WHERE M.SEASON BETWEEN '2016-2017' AND '2021-2022'
GROUP BY M.SEASON, T.TEAM_NAME, CONCAT(MR.FIRST_NAME,' ',MR.LAST_NAME), T.ID
) AS WINS_BY_SEASON
JOIN TEAMS T ON T.ID = WINS_BY_SEASON.TEAM_ID WHERE RN = 1;


